<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DetailHQ Demo</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#f6f7fb}
    .demo-loader{min-height:100%;display:flex;align-items:center;justify-content:center;color:rgba(0,0,0,.7);padding:24px;text-align:center}
  </style>
</head>
<body>
  <div class="demo-loader" id="demo-loader">Demo wird geladen…</div>

  <script>
    window.__DETAILHQ_DEMO = true;
    window.DETAILHQ_DEMO = true;
    (async function () {
      const APP_HTML_PATH = "/app.html";  
      const DEMO_JS_PATH  = "/demo.js?v=" + Date.now();

      const loader = document.getElementById("demo-loader");

      try {
        const res = await fetch(APP_HTML_PATH, { cache: "no-store" });
        if (!res.ok) throw new Error("Konnte app.html nicht laden (" + res.status + ")");
        const raw = await res.text();

        // HTML in ein DOM parsen
        const parser = new DOMParser();
        const doc = parser.parseFromString(raw, "text/html");

        // base setzen, damit relative assets weiterhin stimmen
        if (!doc.querySelector("base")) {
          const base = doc.createElement("base");
          base.setAttribute("href", "/");
          doc.head.insertBefore(base, doc.head.firstChild);
        }

        // Alle Scripts sammeln und aus dem DOM entfernen (damit nichts vor demo.js läuft)
        const scripts = Array.from(doc.querySelectorAll("script"));
        const extracted = scripts.map(s => ({
          src: s.getAttribute("src"),
          type: s.getAttribute("type"),
          nomodule: s.hasAttribute("nomodule"),
          defer: s.hasAttribute("defer"),
          async: s.hasAttribute("async"),
          text: s.src ? "" : (s.textContent || "")
        }));
        scripts.forEach(s => s.remove());

        // Demo-Flag früh setzen
        const flag = doc.createElement("script");
        flag.textContent = "window.DETAILHQ_DEMO = true;";
        doc.head.appendChild(flag);

        // demo.js als ALLERERSTES Script rein
        const demoScript = doc.createElement("script");
        demoScript.src = DEMO_JS_PATH;
        demoScript.defer = true;
        doc.head.appendChild(demoScript);

        // Danach alle originalen Scripts wieder rein (in gleicher Reihenfolge)
        extracted.forEach(s => {
          const el = doc.createElement("script");
          if (s.type) el.type = s.type;
          if (s.nomodule) el.setAttribute("nomodule", "");
          // Wichtig: wir setzen alles auf defer (stabile Reihenfolge)
          el.defer = true;
          if (s.src) el.src = s.src;
          else el.textContent = s.text;
          doc.body.appendChild(el);
        });

        // final rendern
        document.open();
        document.write("<!doctype html>" + doc.documentElement.outerHTML);
        document.close();
      } catch (err) {
        console.error(err);
        if (loader) loader.textContent = "Demo konnte nicht geladen werden: " + (err && err.message ? err.message : String(err));
      }
    })();
  </script>
</body>
</html>
